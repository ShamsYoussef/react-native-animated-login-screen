{"version":3,"sources":["detach/IosAssetArchive.ts"],"names":["buildAssetArchiveAsync","context","destinationCARPath","intermediatesDirectory","StandaloneContextService","Error","data","fs","mkdirpSync","path","join","expoSourcePath","stdio","IosIcons","createAndWriteIconsToPathAsync","sdkMajorVersion","manifest","sdkVersion","deploymentTarget","xcrunargs","relative","cwd"],"mappings":";;;;;;;AAAA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AACA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AAEA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AACA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AACA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;;;;;;;AAEA;;;AAGA,eAAeA,sBAAf,CACEC,OADF,EAEEC,kBAFF,EAGEC,sBAHF,EAIE;AACA,MAAI,EAAEF,OAAO,YAAYG,6CAArB,CAAJ,EAAoD;AAClD,UAAM,IAAIC,KAAJ,CAAU,sEAAV,CAAN;AACD;;AACD,QAAM;AAAEC,IAAAA;AAAF,MAAWL,OAAjB;;AACAM,qBAAGC,UAAH,CAAcL,sBAAd,EALA,CAOA;;;AACA,QAAM,2CACJ,SADI,EAEJ,CACE,IADF,EAEEM,gBAAKC,IAAL,CAAUJ,IAAI,CAACK,cAAf,EAA+B,UAA/B,EAA2C,iBAA3C,CAFF,EAGEF,gBAAKC,IAAL,CAAUP,sBAAV,EAAkC,iBAAlC,CAHF,CAFI,EAOJ;AACES,IAAAA,KAAK,EAAE;AADT,GAPI,CAAN,CARA,CAoBA;;AACA,QAAMC,QAAQ,GAACC,8BAAT,CACJb,OADI,EAEJQ,gBAAKC,IAAL,CAAUP,sBAAV,EAAkC,iBAAlC,EAAqD,oBAArD,CAFI,CAAN;AAKA,QAAMY,eAAe,GAAG,2CAAqBT,IAAI,CAACU,QAAL,CAAcC,UAAnC,CAAxB;AACA,QAAMC,gBAAgB,GAAGH,eAAe,GAAG,EAAlB,GAAuB,MAAvB,GAAgC,KAAzD,CA3BA,CA2BgE;AAEhE;AACA;;AACA,QAAMI,SAAS,GAAG,CAChB,QADgB,EAEhB,6BAFgB,EAEeD,gBAFf,EAGhB,YAHgB,EAGF,UAHE,EAIhB,YAJgB,EAIF,SAJE,EAKhB,6BALgB,EAKe,mCALf,EAMhB,iBANgB,EAOhB,8BAPgB,EAOgB,KAPhB,EAQhB,gBARgB,EAQE,oCARF,EAShB,iBATgB,EASG,QATH,EAUhB,iBAVgB,EAUG,MAVH,EAWhB,WAXgB,EAWHT,gBAAKW,QAAL,CAAcjB,sBAAd,EAAsCD,kBAAtC,CAXG,EAYhB,iBAZgB,CAAlB;AAcA;;;;;;AAKA,QAAM,2CAAqB,OAArB,EAA8BiB,SAA9B,EAAyC;AAC7CP,IAAAA,KAAK,EAAE,CAAC,QAAD,EAAW,QAAX,EAAqB,SAArB,CADsC;AACL;AACxCS,IAAAA,GAAG,EAAElB;AAFwC,GAAzC,CAAN;AAID","sourcesContent":["import fs from 'fs-extra';\nimport path from 'path';\n\nimport { parseSdkMajorVersion, spawnAsyncThrowError } from './ExponentTools';\nimport * as IosIcons from './IosIcons';\nimport { AnyStandaloneContext, StandaloneContextService } from './StandaloneContext';\n\n/**\n *  Compile a .car file from the icons in a manifest.\n */\nasync function buildAssetArchiveAsync(\n  context: AnyStandaloneContext,\n  destinationCARPath: string,\n  intermediatesDirectory: string\n) {\n  if (!(context instanceof StandaloneContextService)) {\n    throw new Error('buildAssetArchive is only supported for service standalone contexts.');\n  }\n  const { data } = context;\n  fs.mkdirpSync(intermediatesDirectory);\n\n  // copy expoSourceRoot/.../Images.xcassets into intermediates\n  await spawnAsyncThrowError(\n    '/bin/cp',\n    [\n      '-R',\n      path.join(data.expoSourcePath, 'Exponent', 'Images.xcassets'),\n      path.join(intermediatesDirectory, 'Images.xcassets'),\n    ],\n    {\n      stdio: 'inherit',\n    }\n  );\n\n  // make the new xcassets contain the project's icon\n  await IosIcons.createAndWriteIconsToPathAsync(\n    context,\n    path.join(intermediatesDirectory, 'Images.xcassets', 'AppIcon.appiconset')\n  );\n\n  const sdkMajorVersion = parseSdkMajorVersion(data.manifest.sdkVersion);\n  const deploymentTarget = sdkMajorVersion > 30 ? '10.0' : '9.0'; // SDK31 drops support for iOS 9.0\n\n  // compile asset archive\n  // prettier-ignore\n  const xcrunargs = [\n    'actool',\n    '--minimum-deployment-target', deploymentTarget,\n    '--platform', 'iphoneos',\n    '--app-icon', 'AppIcon',\n    '--output-partial-info-plist', 'assetcatalog_generated_info.plist',\n    '--compress-pngs',\n    '--enable-on-demand-resources', 'YES',\n    '--product-type', 'com.apple.product-type.application',\n    '--target-device', 'iphone',\n    '--target-device', 'ipad',\n    '--compile', path.relative(intermediatesDirectory, destinationCARPath),\n    'Images.xcassets',\n  ]\n  /*\n   *  Note: if you want to debug issues with `actool`, try changing to stdio: 'inherit'.\n   *  In both success and failure cases, actool will write an enormous .plist to stdout\n   *  which may contain the key `com.apple.actool.errors`. Great work Apple\n   */\n  await spawnAsyncThrowError('xcrun', xcrunargs, {\n    stdio: ['ignore', 'ignore', 'inherit'], // only stderr\n    cwd: intermediatesDirectory,\n  });\n}\n\nexport { buildAssetArchiveAsync };\n"],"file":"../../detach/IosAssetArchive.js","sourceRoot":"/@expo/xdl@57.9.17/src"}