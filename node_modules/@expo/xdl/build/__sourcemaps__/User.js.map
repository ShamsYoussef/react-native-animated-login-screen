{"version":3,"sources":["User.ts"],"names":["ANONYMOUS_USERNAME","UserManagerInstance","Semaphore","getGlobalInstance","__globalInstance","initialize","_currentUser","_getSessionLock","loginAsync","loginType","loginArgs","Error","apiAnonymous","ApiV2Client","clientForUser","loginResp","postAsync","username","password","error","XDLError","_getProfileAsync","currentConnection","sessionSecret","registerAsync","userData","user","getCurrentUserAsync","logoutAsync","registeredUser","createOrUpdateUserAsync","connection","email","givenName","familyName","e","console","message","ensureLoggedInAsync","Config","offline","silent","_interactiveAuthenticationCallbackAsync","setInteractiveAuthenticationCallback","callback","_readUserData","auth","UserSettings","getAsync","options","acquire","data","Logger","global","warn","code","release","getCurrentUsernameAsync","getSessionAsync","currentUser","api","updatedUser","_prepareAuth0Profile","_parseAuth0Profile","kind","Analytics","logEvent","deleteKeyAsync","forgotPasswordAsync","usernameOrEmail","setAsync","userId","setUserProperties","rawProfile","Object","keys","reduce","p","key","niceProfile"],"mappings":"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","sourcesContent":["import camelCase from 'lodash/camelCase';\nimport isEmpty from 'lodash/isEmpty';\nimport snakeCase from 'lodash/snakeCase';\n\nimport * as Analytics from './Analytics';\nimport ApiV2Client from './ApiV2';\nimport Config from './Config';\nimport Logger from './Logger';\nimport UserSettings, { UserData } from './UserSettings';\nimport { Semaphore } from './Utils';\nimport XDLError from './XDLError';\n\nexport type User = {\n  kind: 'user';\n  // required\n  username: string;\n  nickname: string;\n  userId: string;\n  picture: string;\n  // optional\n  email?: string;\n  emailVerified?: boolean;\n  givenName?: string;\n  familyName?: string;\n  userMetadata: {\n    onboarded: boolean;\n    legacy?: boolean;\n  };\n  currentConnection: ConnectionType;\n  sessionSecret: string;\n};\n\nexport type LegacyUser = {\n  kind: 'legacyUser';\n  username: string;\n  userMetadata: {\n    legacy: boolean;\n    needsPasswordMigration: boolean;\n  };\n};\n\nexport type UserOrLegacyUser = User | LegacyUser;\n\nexport type ConnectionType =\n  | 'Username-Password-Authentication'\n  | 'facebook'\n  | 'google-oauth2'\n  | 'github';\n\nexport type RegistrationData = {\n  username: string;\n  password: string;\n  email?: string;\n  givenName?: string;\n  familyName?: string;\n};\n\nexport type LoginType = 'user-pass' | 'facebook' | 'google' | 'github';\n\nexport const ANONYMOUS_USERNAME = 'anonymous';\n\nexport class UserManagerInstance {\n  _currentUser: User | null = null;\n  _getSessionLock = new Semaphore();\n  _interactiveAuthenticationCallbackAsync?: () => Promise<User>;\n\n  static getGlobalInstance() {\n    if (!__globalInstance) {\n      __globalInstance = new UserManagerInstance();\n    }\n    return __globalInstance;\n  }\n\n  initialize() {\n    this._currentUser = null;\n    this._getSessionLock = new Semaphore();\n  }\n\n  /**\n   * Logs in a user for a given login type.\n   *\n   * Valid login types are:\n   *  - \"user-pass\": Username and password authentication\n   *\n   * If the login type is \"user-pass\", we directly make the request to www\n   * to login a user.\n   */\n  async loginAsync(\n    loginType: LoginType,\n    loginArgs?: { username: string; password: string }\n  ): Promise<User> {\n    if (loginType === 'user-pass') {\n      if (!loginArgs) {\n        throw new Error(`The 'user-pass' login type requires a username and password.`);\n      }\n      const apiAnonymous = ApiV2Client.clientForUser();\n      const loginResp = await apiAnonymous.postAsync('auth/loginAsync', {\n        username: loginArgs.username,\n        password: loginArgs.password,\n      });\n      if (loginResp.error) {\n        throw new XDLError('INVALID_USERNAME_PASSWORD', loginResp['error_description']);\n      }\n      return this._getProfileAsync({\n        currentConnection: 'Username-Password-Authentication',\n        sessionSecret: loginResp.sessionSecret,\n      });\n    } else {\n      throw new Error(`Invalid login type provided. Must be 'user-pass'.`);\n    }\n  }\n\n  async registerAsync(\n    userData: RegistrationData,\n    user: UserOrLegacyUser | null = null\n  ): Promise<User> {\n    if (!user) {\n      user = await this.getCurrentUserAsync();\n    }\n\n    if (user) {\n      await this.logoutAsync();\n      user = null;\n    }\n\n    try {\n      // Create or update the profile\n      let registeredUser = await this.createOrUpdateUserAsync({\n        connection: 'Username-Password-Authentication', // Always create/update username password\n        email: userData.email,\n        givenName: userData.givenName,\n        familyName: userData.familyName,\n        username: userData.username,\n        password: userData.password,\n      });\n\n      registeredUser = await this.loginAsync('user-pass', {\n        username: userData.username,\n        password: userData.password,\n      });\n\n      return registeredUser;\n    } catch (e) {\n      console.error(e);\n      throw new XDLError('REGISTRATION_ERROR', 'Error registering user: ' + e.message);\n    }\n  }\n\n  /**\n   * Ensure user is logged in and has a valid token.\n   *\n   * If there are any issues with the login, this method throws.\n   */\n  async ensureLoggedInAsync(): Promise<User> {\n    if (Config.offline) {\n      throw new XDLError('NETWORK_REQUIRED', \"Can't verify user without network access\");\n    }\n\n    let user = await this.getCurrentUserAsync({ silent: true });\n    if (!user && this._interactiveAuthenticationCallbackAsync) {\n      user = await this._interactiveAuthenticationCallbackAsync();\n    }\n    if (!user) {\n      throw new XDLError('NOT_LOGGED_IN', 'Not logged in');\n    }\n    return user;\n  }\n\n  setInteractiveAuthenticationCallback(callback: () => Promise<User>) {\n    this._interactiveAuthenticationCallbackAsync = callback;\n  }\n\n  async _readUserData(): Promise<UserData | null> {\n    let auth = await UserSettings.getAsync('auth', null);\n    if (isEmpty(auth)) {\n      // XXX(ville):\n      // We sometimes read an empty string from ~/.expo/state.json,\n      // even though it has valid credentials in it.\n      // We don't know why.\n      // An empty string can't be parsed as JSON, so an empty default object is returned.\n      // In this case, retrying usually helps.\n      auth = await UserSettings.getAsync('auth', null);\n    }\n    if (typeof auth === 'undefined') {\n      return null;\n    }\n    return auth;\n  }\n\n  /**\n   * Get the current user based on the available token.\n   * If there is no current token, returns null.\n   */\n  async getCurrentUserAsync(options?: { silent?: boolean }): Promise<User | null> {\n    await this._getSessionLock.acquire();\n\n    try {\n      // If user is cached and there is a sessionSecret, return the user\n      if (this._currentUser && this._currentUser.sessionSecret) {\n        return this._currentUser;\n      }\n\n      if (Config.offline) {\n        return null;\n      }\n\n      const data = await this._readUserData();\n\n      // No session, no current user. Need to login\n      if (!data || !data.sessionSecret) {\n        return null;\n      }\n\n      try {\n        return await this._getProfileAsync({\n          currentConnection: data.currentConnection,\n          sessionSecret: data.sessionSecret,\n        });\n      } catch (e) {\n        if (!(options && options.silent)) {\n          Logger.global.warn('Fetching the user profile failed');\n          Logger.global.warn(e);\n        }\n        if (e.code === 'UNAUTHORIZED_ERROR') {\n          return null;\n        }\n        throw e;\n      }\n    } finally {\n      this._getSessionLock.release();\n    }\n  }\n\n  async getCurrentUsernameAsync(): Promise<string | null> {\n    const data = await this._readUserData();\n    if (!data || !data.username) {\n      return null;\n    }\n    return data.username;\n  }\n\n  async getSessionAsync(): Promise<{ sessionSecret: string } | null> {\n    const data = await this._readUserData();\n    if (!data || !data.sessionSecret) {\n      return null;\n    }\n    return { sessionSecret: data.sessionSecret };\n  }\n\n  /**\n   * Create or update a user.\n   */\n  async createOrUpdateUserAsync(userData: object): Promise<User | null> {\n    let currentUser = this._currentUser;\n    if (!currentUser) {\n      // attempt to get the current user\n      currentUser = await this.getCurrentUserAsync();\n    }\n\n    const api = ApiV2Client.clientForUser(currentUser);\n\n    const { user: updatedUser } = await api.postAsync('auth/createOrUpdateUser', {\n      userData: _prepareAuth0Profile(userData),\n    });\n\n    this._currentUser = {\n      ...this._currentUser,\n      ..._parseAuth0Profile(updatedUser),\n      kind: 'user',\n    };\n    return this._currentUser;\n  }\n\n  /**\n   * Logout\n   */\n  async logoutAsync(): Promise<void> {\n    if (this._currentUser) {\n      Analytics.logEvent('Logout', {\n        username: this._currentUser.username,\n      });\n    }\n\n    this._currentUser = null;\n\n    // Delete saved auth info\n    await UserSettings.deleteKeyAsync('auth');\n  }\n\n  /**\n   * Forgot Password\n   */\n  async forgotPasswordAsync(usernameOrEmail: string): Promise<void> {\n    const apiAnonymous = ApiV2Client.clientForUser();\n    return apiAnonymous.postAsync('auth/forgotPasswordAsync', {\n      usernameOrEmail,\n    });\n  }\n\n  /**\n   * Get profile given token data. Errors if token is not valid or if no\n   * user profile is returned.\n   *\n   * This method is called by all public authentication methods of `UserManager`\n   * except `logoutAsync`. Therefore, we use this method as a way to:\n   *  - update the UserSettings store with the current token and user id\n   *  - update UserManager._currentUser\n   *  - Fire login analytics events\n   *\n   * Also updates UserManager._currentUser.\n   *\n   * @private\n   */\n  async _getProfileAsync({\n    currentConnection,\n    sessionSecret,\n  }: {\n    currentConnection?: ConnectionType;\n    sessionSecret: string;\n  }): Promise<User> {\n    let user;\n    let api = ApiV2Client.clientForUser({\n      sessionSecret,\n    });\n\n    user = await api.postAsync('auth/userProfileAsync');\n\n    if (!user) {\n      throw new Error('Unable to fetch user.');\n    }\n\n    user = {\n      ..._parseAuth0Profile(user),\n      kind: 'user',\n      currentConnection,\n      sessionSecret,\n    };\n\n    await UserSettings.setAsync('auth', {\n      userId: user.userId,\n      username: user.username,\n      currentConnection,\n      sessionSecret,\n    });\n\n    // If no currentUser, or currentUser.id differs from profiles\n    // user id, that means we have a new login\n    if (\n      (!this._currentUser || this._currentUser.userId !== user.userId) &&\n      user.username &&\n      user.username !== ''\n    ) {\n      Analytics.logEvent('Login', {\n        userId: user.userId,\n        currentConnection: user.currentConnection,\n        username: user.username,\n      });\n\n      Analytics.setUserProperties(user.username, {\n        userId: user.userId,\n        currentConnection: user.currentConnection,\n        username: user.username,\n      });\n    }\n\n    this._currentUser = user;\n\n    return user;\n  }\n}\n\nlet __globalInstance: UserManagerInstance | undefined;\nexport default UserManagerInstance.getGlobalInstance();\n\n/** Private Methods **/\nfunction _parseAuth0Profile(rawProfile: any) {\n  if (!rawProfile || typeof rawProfile !== 'object') {\n    return rawProfile;\n  }\n  return Object.keys(rawProfile).reduce((p, key) => {\n    p[camelCase(key)] = _parseAuth0Profile(rawProfile[key]);\n    return p;\n  }, {} as any);\n}\n\nfunction _prepareAuth0Profile(niceProfile: any) {\n  if (typeof niceProfile !== 'object') {\n    return niceProfile;\n  }\n\n  return Object.keys(niceProfile).reduce((p, key) => {\n    p[snakeCase(key)] = _prepareAuth0Profile(niceProfile[key]);\n    return p;\n  }, {} as any);\n}\n"],"file":"../User.js","sourceRoot":"/@expo/xdl@57.9.17/src"}