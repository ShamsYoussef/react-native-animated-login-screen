{"version":3,"sources":["credentials/Credentials.ts"],"names":["getCredentialMetadataAsync","projectRoot","platform","exp","skipSDKVersionRequirement","user","UserManager","ensureLoggedInAsync","username","owner","bundleIdentifier","ios","undefined","experienceName","slug","credentialsExistForPlatformAsync","metadata","credentials","fetchCredentials","getEncryptedCredentialsForPlatformAsync","getCredentialsForPlatform","decrypt","process","env","EXPO_NEXT_API","api","ApiV2","clientForUser","getAsync","record","encodeURI","pushCredentials","distCredentials","response","Api","callMethodAsync","err","Error","updateCredentialsForPlatform","newCredentials","userCredentialsIds","result","putAsync","keystore","errors","JSON","stringify","removeCredentialsForPlatform","deleteAsync"],"mappings":"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","sourcesContent":["import { Platform, getConfig } from '@expo/config';\nimport { ApiV2 } from '../xdl';\nimport { Keystore } from './AndroidCredentials';\n\nimport Api from '../Api';\nimport UserManager from '../User';\nimport * as Ios from './IosCredentials';\n\nexport type Credentials = Ios.Credentials; // can't import android types from typescript\n\nexport type CredentialMetadata = {\n  username: string;\n  experienceName: string;\n  bundleIdentifier?: string;\n  platform: string;\n  only?: any;\n};\n\nexport { Ios };\n\nexport async function getCredentialMetadataAsync(\n  projectRoot: string,\n  platform: Platform\n): Promise<CredentialMetadata> {\n  const { exp } = getConfig(projectRoot, { skipSDKVersionRequirement: true });\n\n  const user = await UserManager.ensureLoggedInAsync();\n  let { username } = user;\n  if (exp.owner) {\n    username = exp.owner;\n  }\n\n  const bundleIdentifier = platform === 'ios' ? exp.ios?.bundleIdentifier : undefined;\n\n  return {\n    username,\n    experienceName: `@${username}/${exp.slug}`,\n    bundleIdentifier,\n    platform,\n  };\n}\n\nexport async function credentialsExistForPlatformAsync(\n  metadata: CredentialMetadata\n): Promise<boolean> {\n  const credentials = await fetchCredentials(metadata, false);\n  return !!credentials;\n}\n\nexport async function getEncryptedCredentialsForPlatformAsync(\n  metadata: CredentialMetadata\n): Promise<Credentials | undefined | null> {\n  return fetchCredentials(metadata, false);\n}\n\nexport async function getCredentialsForPlatform(\n  metadata: CredentialMetadata\n): Promise<Credentials | undefined | null> {\n  return fetchCredentials(metadata, true);\n}\n\nasync function fetchCredentials(\n  { username, experienceName, bundleIdentifier, platform }: CredentialMetadata,\n  decrypt: boolean\n): Promise<Credentials | undefined | null> {\n  // this doesn't hit our mac rpc channel, so it needs significantly less debugging\n  let credentials;\n  if (process.env.EXPO_NEXT_API === 'true') {\n    const user = await UserManager.ensureLoggedInAsync();\n    const api = ApiV2.clientForUser(user);\n\n    if (platform === 'android') {\n      credentials = await api.getAsync(`credentials/android/keystore/${experienceName}`);\n      if (credentials['keystore']) {\n        credentials['keystore']['keystoreAlias'] = credentials['keystore']['keyAlias'];\n        delete credentials['keystore']['keyAlias'];\n      } else {\n        credentials = null;\n      }\n    } else if (platform === 'ios') {\n      const record = await api.getAsync(\n        `credentials/ios/${experienceName}/${encodeURI(bundleIdentifier ?? '')}`\n      );\n      if (record) {\n        credentials = {\n          ...record.pushCredentials,\n          ...record.distCredentials,\n          ...record.credentials,\n        };\n      } else {\n        credentials = {};\n      }\n    }\n  } else {\n    const response = await Api.callMethodAsync('getCredentials', [], 'post', {\n      username,\n      experienceName,\n      bundleIdentifier,\n      platform,\n      decrypt,\n    });\n\n    if (response.err) {\n      throw new Error('Error fetching credentials.');\n    }\n    credentials = response.credentials;\n  }\n  return credentials;\n}\n\nexport async function updateCredentialsForPlatform(\n  platform: 'android',\n  newCredentials: Keystore,\n  userCredentialsIds: Array<number>,\n  metadata: CredentialMetadata\n): Promise<void> {\n  if (process.env.EXPO_NEXT_API === 'true') {\n    const { experienceName } = metadata;\n    const user = await UserManager.ensureLoggedInAsync();\n    const api = ApiV2.clientForUser(user);\n    const result = await api.putAsync(`credentials/android/keystore/${experienceName}`, {\n      keystore: newCredentials,\n    });\n\n    if (result.errors) {\n      throw new Error(`Error updating credentials: ${JSON.stringify(result.errors)}`);\n    }\n  } else {\n    const { err, credentials } = await Api.callMethodAsync('updateCredentials', [], 'post', {\n      credentials: newCredentials,\n      userCredentialsIds,\n      platform,\n      ...metadata,\n    });\n\n    if (err || !credentials) {\n      throw new Error('Error updating credentials.');\n    }\n  }\n}\n\nexport async function removeCredentialsForPlatform(\n  platform: 'android', // this is only used for android credential management now.\n  metadata: CredentialMetadata\n): Promise<void> {\n  // doesn't go through mac rpc, no request id needed\n  if (process.env.EXPO_NEXT_API === 'true') {\n    const user = await UserManager.ensureLoggedInAsync();\n    const api = ApiV2.clientForUser(user);\n    await api.deleteAsync(`credentials/android/keystore/${metadata.experienceName}`);\n  } else {\n    const { err } = await Api.callMethodAsync('deleteCredentials', [], 'post', {\n      platform,\n      ...metadata,\n    });\n\n    if (err) {\n      throw new Error('Error deleting credentials.');\n    }\n  }\n}\n"],"file":"../../credentials/Credentials.js","sourceRoot":"/@expo/xdl@57.9.17/src"}