{"version":3,"sources":["credentials/AndroidCredentials.ts"],"names":["log","logger","global","NEWLINE","process","platform","javaExecutable","exportCertBinary","keystorePath","keystorePassword","keyAlias","certFile","err","code","warn","info","exportCertBase64","logKeystoreHashes","keystoreInfo","linePrefix","data","fs","readFile","googleHash","crypto","createHash","update","digest","toUpperCase","googleHash256","fbHash","replace","stdout","stderr","error","unlink","logKeystoreCredentials","keyPassword","title","chalk","bold","createKeystore","androidPackage","generateUploadKeystore","uploadKeystorePath","experienceName","keystoreData","Buffer","from","toString"],"mappings":"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","sourcesContent":["import spawnAsync, { SpawnResult } from '@expo/spawn-async';\nimport axios from 'axios';\nimport chalk from 'chalk';\nimport crypto from 'crypto';\nimport fs from 'fs-extra';\nimport path from 'path';\nimport ProgressBar from 'progress';\nimport uuidv4 from 'uuid/v4';\n\nimport logger from '../Logger';\nimport UserSettings from '../UserSettings';\n\nconst log = logger.global;\nconst NEWLINE = process.platform === 'win32' ? '\\r\\n' : '\\n';\nconst javaExecutable = process.platform === 'win32' ? 'java.exe' : 'java';\n\nexport type Keystore = {\n  keystore: string;\n  keystorePassword: string;\n  keyPassword: string;\n  keyAlias: string;\n};\n\nexport type KeystoreInfo = {\n  keystorePath: string;\n  keystorePassword: string;\n  keyPassword: string;\n  keyAlias: string;\n};\n\nexport async function exportCertBinary(\n  {\n    keystorePath,\n    keystorePassword,\n    keyAlias,\n  }: Pick<KeystoreInfo, 'keystorePath' | 'keystorePassword' | 'keyAlias'>,\n  certFile: string\n): Promise<SpawnResult> {\n  try {\n    return spawnAsync('keytool', [\n      '-exportcert',\n      '-keystore',\n      keystorePath,\n      '-storepass',\n      keystorePassword,\n      '-alias',\n      keyAlias,\n      '-file',\n      certFile,\n      '-noprompt',\n      '-storetype',\n      'JKS',\n    ]);\n  } catch (err) {\n    if (err.code === 'ENOENT') {\n      log.warn('Are you sure you have keytool installed?');\n      log.info('keytool is a part of OpenJDK: https://openjdk.java.net/');\n      log.info('Also make sure that keytool is in your PATH after installation.');\n    }\n    throw err;\n  }\n}\n\nexport async function exportCertBase64(\n  {\n    keystorePath,\n    keystorePassword,\n    keyAlias,\n  }: Pick<KeystoreInfo, 'keystorePath' | 'keystorePassword' | 'keyAlias'>,\n  certFile: string\n): Promise<SpawnResult> {\n  try {\n    return spawnAsync('keytool', [\n      '-export',\n      '-rfc',\n      '-keystore',\n      keystorePath,\n      '-storepass',\n      keystorePassword,\n      '-alias',\n      keyAlias,\n      '-file',\n      certFile,\n      '-noprompt',\n      '-storetype',\n      'JKS',\n    ]);\n  } catch (err) {\n    if (err.code === 'ENOENT') {\n      log.warn('Are you sure you have keytool installed?');\n      log.info('keytool is a part of OpenJDK: https://openjdk.java.net/');\n      log.info('Also make sure that keytool is in your PATH after installation.');\n    }\n    throw err;\n  }\n}\n\nexport async function logKeystoreHashes(keystoreInfo: KeystoreInfo, linePrefix: string = '') {\n  const { keystorePath } = keystoreInfo;\n  const certFile = `${keystorePath}.cer`;\n  try {\n    await exportCertBinary(keystoreInfo, certFile);\n    const data = await fs.readFile(certFile);\n    const googleHash = crypto.createHash('sha1').update(data).digest('hex').toUpperCase();\n    const googleHash256 = crypto.createHash('sha256').update(data).digest('hex').toUpperCase();\n    const fbHash = crypto.createHash('sha1').update(data).digest('base64');\n    log.info(\n      `${linePrefix}Google Certificate Fingerprint:     ${googleHash.replace(\n        /(.{2}(?!$))/g,\n        '$1:'\n      )}`\n    );\n    log.info(`${linePrefix}Google Certificate Hash (SHA-1):    ${googleHash}`);\n    log.info(`${linePrefix}Google Certificate Hash (SHA-256):  ${googleHash256}`);\n    log.info(`${linePrefix}Facebook Key Hash:                  ${fbHash}`);\n  } catch (err) {\n    if (err.code === 'ENOENT') {\n      log.warn('Are you sure you have keytool installed?');\n      log.info('keytool is a part of OpenJDK: https://openjdk.java.net/');\n      log.info('Also make sure that keytool is in your PATH after installation.');\n    }\n    if (err.stdout) {\n      log.info(err.stdout);\n    }\n    if (err.stderr) {\n      log.error(err.stderr);\n    }\n    throw err;\n  } finally {\n    try {\n      await fs.unlink(certFile);\n    } catch (err) {\n      if (err.code !== 'ENOENT') {\n        log.error(err);\n      }\n    }\n  }\n}\n\nexport function logKeystoreCredentials(\n  {\n    keystorePassword,\n    keyAlias,\n    keyPassword,\n  }: Pick<Keystore, 'keystorePassword' | 'keyAlias' | 'keyPassword'>,\n  title: string = 'Keystore credentials',\n  linePrefix: string = ''\n) {\n  log.info(`${linePrefix}${title}\n${linePrefix}    Keystore password: ${chalk.bold(keystorePassword)}\n${linePrefix}    Key alias:         ${chalk.bold(keyAlias)}\n${linePrefix}    Key password:      ${chalk.bold(keyPassword)}\n  `);\n}\n\nexport async function createKeystore(\n  { keystorePath, keystorePassword, keyAlias, keyPassword }: KeystoreInfo,\n  androidPackage: string\n): Promise<SpawnResult> {\n  try {\n    return await spawnAsync('keytool', [\n      '-genkey',\n      '-v',\n      '-storetype',\n      'JKS',\n      '-storepass',\n      keystorePassword,\n      '-keypass',\n      keyPassword,\n      '-keystore',\n      keystorePath,\n      '-alias',\n      keyAlias,\n      '-keyalg',\n      'RSA',\n      '-keysize',\n      '2048',\n      '-validity',\n      '10000',\n      '-dname',\n      `CN=${androidPackage},OU=,O=,L=,S=,C=US`,\n    ]);\n  } catch (error) {\n    if (error.code === 'ENOENT') {\n      log.warn('Are you sure you have keytool installed?');\n      log.info('keytool is a part of OpenJDK: https://openjdk.java.net/');\n      log.info('Also make sure that keytool is in your PATH after installation.');\n    }\n    throw error;\n  }\n}\n\nexport async function generateUploadKeystore(\n  uploadKeystorePath: string,\n  androidPackage: string,\n  experienceName: string\n): Promise<KeystoreInfo> {\n  const keystoreData = {\n    keystorePassword: uuidv4().replace(/-/g, ''),\n    keyPassword: uuidv4().replace(/-/g, ''),\n    keyAlias: Buffer.from(experienceName).toString('base64'),\n    keystorePath: uploadKeystorePath,\n  };\n  await createKeystore(keystoreData, androidPackage);\n  return keystoreData;\n}\n"],"file":"../../credentials/AndroidCredentials.js","sourceRoot":"/@expo/xdl@57.9.17/src"}