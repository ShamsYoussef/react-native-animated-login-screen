{"version":3,"sources":["../../../src/commands/build-native/utils.ts"],"names":["waitForBuildEndAsync","client","projectId","buildId","timeoutSec","intervalSec","spinner","start","time","Date","getTime","endTime","buildInfo","getAsync","status","succeed","artifacts","buildUrl","text","fail","Error","warn","makeProjectTarballAsync","tarPath","changes","stdout","length","size","fs","stat","printBuildTable","builds","headers","colWidths","refactoredBuilds","map","build","buildTable","console","log"],"mappings":"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","sourcesContent":["import spawnAsync from '@expo/spawn-async';\nimport { ApiV2 } from '@expo/xdl';\nimport delayAsync from 'delay-async';\nimport fs from 'fs-extra';\nimport ora from 'ora';\n\nimport log from '../../log';\nimport { printTableJsonArray } from '../utils/cli-table';\nimport { BuildInfo } from './Builder';\n\nasync function waitForBuildEndAsync(\n  client: ApiV2,\n  projectId: string,\n  buildId: string,\n  { timeoutSec = 1800, intervalSec = 30 } = {}\n): Promise<string> {\n  log('Waiting for build to complete. You can press Ctrl+C to exit.');\n  const spinner = ora().start();\n  let time = new Date().getTime();\n  const endTime = time + timeoutSec * 1000;\n  while (time <= endTime) {\n    const buildInfo: BuildInfo = await client.getAsync(`projects/${projectId}/builds/${buildId}`);\n    switch (buildInfo.status) {\n      case 'finished':\n        spinner.succeed('Build finished.');\n        return buildInfo.artifacts?.buildUrl ?? '';\n      case 'in-queue':\n        spinner.text = 'Build queued...';\n        break;\n      case 'in-progress':\n        spinner.text = 'Build in progress...';\n        break;\n      case 'errored':\n        spinner.fail('Build failed.');\n        throw new Error(`Standalone build failed!`);\n      default:\n        spinner.warn('Unknown status.');\n        throw new Error(`Unknown status: ${buildInfo} - aborting!`);\n    }\n    time = new Date().getTime();\n    await delayAsync(intervalSec * 1000);\n  }\n  spinner.warn('Timed out.');\n  throw new Error(\n    'Timeout reached! It is taking longer than expected to finish the build, aborting...'\n  );\n}\n\nasync function makeProjectTarballAsync(tarPath: string): Promise<number> {\n  const spinner = ora('Making project tarball').start();\n  const changes = (await spawnAsync('git', ['status', '-s'])).stdout;\n  if (changes.length > 0) {\n    spinner.fail('Could not make project tarball');\n    throw new Error('Please commit all files before trying to build your project. Aborting...');\n  }\n  await spawnAsync('git', [\n    'archive',\n    '--format=tar.gz',\n    '--prefix',\n    'project/',\n    '-o',\n    tarPath,\n    'HEAD',\n  ]);\n  spinner.succeed('Project tarball created.');\n\n  const { size } = await fs.stat(tarPath);\n  return size;\n}\n\nfunction printBuildTable(builds: BuildInfo[]) {\n  const headers = ['platform', 'status', 'artifacts'];\n  const colWidths = [10, 15, 80];\n  const refactoredBuilds = builds.map(build => ({\n    ...build,\n    artifacts: build.artifacts?.buildUrl ?? 'not available',\n  }));\n  const buildTable = printTableJsonArray(headers, refactoredBuilds, colWidths);\n  console.log(buildTable);\n}\n\nexport { waitForBuildEndAsync, makeProjectTarballAsync, printBuildTable };\n"],"file":"utils.js"}