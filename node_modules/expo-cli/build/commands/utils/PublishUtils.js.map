{"version":3,"sources":["../../../src/commands/utils/PublishUtils.ts"],"names":["VERSION","getPublishHistoryAsync","projectDir","options","count","isNaN","Error","user","UserManager","ensureLoggedInAsync","exp","skipSDKVersionRequirement","api","ApiV2","clientForUser","postAsync","owner","slug","Project","getSlugAsync","version","releaseChannel","platform","sdkVersion","setPublishToChannelAsync","publishId","_rollbackPublicationFromChannelForPlatformAsync","historyQueryResult","history","queryResult","length","secondMostRecent","nonInteractiveOptions","parent","_printAndConfirm","publicationId","revertProgress","start","succeed","rollbackPublicationFromChannelAsync","restOfTheOptions","platforms","completedPlatforms","push","e","log","error","filter","includes","channel","partialOptions","detailOptions","detail","getPublicationDetailAsync","printPublicationDetailAsync","nonInteractive","confirm","type","name","message","result","raw","console","JSON","stringify","manifest","generalTableString","table","printTableJson","manifestTableString"],"mappings":"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","sourcesContent":["import { getConfig } from '@expo/config';\nimport { Api, ApiV2, FormData, Project, UserManager } from '@expo/xdl';\nimport ora from 'ora';\nimport * as table from './cli-table';\nimport log from '../../log';\nimport prompt from '../../prompt';\n\nexport type HistoryOptions = {\n  releaseChannel?: string;\n  count?: number;\n  platform?: 'android' | 'ios';\n  raw?: boolean;\n  sdkVersion?: string;\n};\n\nexport type DetailOptions = {\n  publishId?: string;\n  raw?: boolean;\n};\n\nexport type SetOptions = { releaseChannel: string; publishId: string };\n\nexport type RollbackOptions = {\n  releaseChannel: string;\n  sdkVersion: string;\n  platform?: 'android' | 'ios';\n  parent?: { nonInteractive?: boolean };\n};\n\nexport type Publication = {\n  fullName: string;\n  channel: string;\n  channelId: string;\n  publicationId: string;\n  appVersion: string;\n  sdkVersion: string;\n  publishedTime: string;\n  platform: 'android' | 'ios';\n};\n\nexport type PublicationDetail = {\n  manifest: {\n    [key: string]: string;\n  };\n  publishedTime: string;\n  publishingUsername: string;\n  packageUsername: string;\n  packageName: string;\n  fullName: string;\n  hash: string;\n  sdkVersion: string;\n  s3Key: string;\n  s3Url: string;\n  abiVersion: string | null;\n  bundleUrl: string | null;\n  platform: string;\n  version: string;\n  revisionId: string;\n  channels: { [key: string]: string }[];\n  publicationId: string;\n};\n\nconst VERSION = 2;\n\nexport async function getPublishHistoryAsync(\n  projectDir: string,\n  options: HistoryOptions\n): Promise<any> {\n  if (options.count && (isNaN(options.count) || options.count < 1 || options.count > 100)) {\n    throw new Error('-n must be a number between 1 and 100 inclusive');\n  }\n\n  // TODO(ville): handle the API result for not authenticated user instead of checking upfront\n  const user = await UserManager.ensureLoggedInAsync();\n  const { exp } = getConfig(projectDir, {\n    skipSDKVersionRequirement: true,\n  });\n\n  const api = ApiV2.clientForUser(user);\n  return await api.postAsync('publish/history', {\n    owner: exp.owner,\n    slug: await Project.getSlugAsync(projectDir),\n    version: VERSION,\n    releaseChannel: options.releaseChannel,\n    count: options.count,\n    platform: options.platform,\n    sdkVersion: options.sdkVersion,\n  });\n}\n\nexport async function setPublishToChannelAsync(\n  projectDir: string,\n  options: SetOptions\n): Promise<any> {\n  const user = await UserManager.ensureLoggedInAsync();\n  const api = ApiV2.clientForUser(user);\n  return await api.postAsync('publish/set', {\n    releaseChannel: options.releaseChannel,\n    publishId: options.publishId,\n    slug: await Project.getSlugAsync(projectDir),\n  });\n}\n\nasync function _rollbackPublicationFromChannelForPlatformAsync(\n  projectDir: string,\n  platform: 'android' | 'ios',\n  options: Omit<RollbackOptions, 'platform'>\n) {\n  const { releaseChannel, sdkVersion } = options;\n  // get the 2 most recent things in the channel history\n  const historyQueryResult = await getPublishHistoryAsync(projectDir, {\n    releaseChannel,\n    platform,\n    sdkVersion,\n    count: 2,\n  });\n\n  const history = historyQueryResult.queryResult as Publication[];\n  if (history.length === 0) {\n    throw new Error(\n      `There isn't anything published for release channel: ${releaseChannel}, sdk version: ${sdkVersion}, platform: ${platform}`\n    );\n  } else if (history.length === 1) {\n    throw new Error(\n      `There is only 1 publication for release channel: ${releaseChannel}, sdk version: ${sdkVersion}, platform: ${platform}. There won't be anything for users to receive if we rollback.`\n    );\n  }\n\n  // The second most recent publication in the history\n  const secondMostRecent = history[history.length - 1];\n\n  const nonInteractiveOptions = options.parent ? { parent: options.parent } : {};\n  // confirm that users will be receiving the secondMostRecent item in the Publish history\n  await _printAndConfirm(\n    projectDir,\n    secondMostRecent.publicationId,\n    releaseChannel,\n    platform,\n    nonInteractiveOptions\n  );\n\n  // apply the revert publication to channel\n  const revertProgress = ora(\n    `${platform}: Applying a revert publication to channel ${releaseChannel}`\n  ).start();\n  await setPublishToChannelAsync(projectDir, {\n    releaseChannel,\n    publishId: secondMostRecent.publicationId,\n  });\n  revertProgress.succeed(\n    `${platform}: Successfully applied revert publication. You can view it with \\`publish:history\\``\n  );\n}\n\nexport async function rollbackPublicationFromChannelAsync(\n  projectDir: string,\n  options: RollbackOptions\n) {\n  const { platform, ...restOfTheOptions } = options;\n\n  if (platform) {\n    return await _rollbackPublicationFromChannelForPlatformAsync(\n      projectDir,\n      platform,\n      restOfTheOptions\n    );\n  }\n\n  const platforms = ['android', 'ios'] as ('android' | 'ios')[];\n  const completedPlatforms = [] as ('android' | 'ios')[];\n  try {\n    for (const platform of platforms) {\n      await _rollbackPublicationFromChannelForPlatformAsync(projectDir, platform, restOfTheOptions);\n      completedPlatforms.push(platform);\n    }\n  } catch (e) {\n    if (completedPlatforms.length > 0) {\n      log.error(\n        `The platforms ${platforms.filter(\n          platform => !completedPlatforms.includes(platform)\n        )} have not been rolled back. You can complete the missing platforms by running \\`expo publish:rollback\\` with the --platform flag`\n      );\n    }\n    throw e;\n  }\n}\n\nasync function _printAndConfirm(\n  projectDir: string,\n  publicationId: string,\n  channel: string,\n  platform: string,\n  partialOptions: { parent?: { nonInteractive?: boolean } }\n): Promise<void> {\n  const detailOptions = {\n    publishId: publicationId,\n  };\n  const detail = await getPublicationDetailAsync(projectDir, detailOptions);\n  await printPublicationDetailAsync(detail, detailOptions);\n\n  if (partialOptions.parent && partialOptions.parent.nonInteractive) {\n    return;\n  }\n  const { confirm } = await prompt([\n    {\n      type: 'confirm',\n      name: 'confirm',\n      message: `${platform}: Users on the '${channel}' channel will receive the above publication as a result of the rollback.`,\n    },\n  ]);\n\n  if (!confirm) {\n    throw new Error(`You can run 'publish:set' to send the desired publication to users`);\n  }\n}\n\nexport async function getPublicationDetailAsync(\n  projectDir: string,\n  options: DetailOptions\n): Promise<PublicationDetail> {\n  // TODO(ville): handle the API result for not authenticated user instead of checking upfront\n  const user = await UserManager.ensureLoggedInAsync();\n  const { exp } = getConfig(projectDir, {\n    skipSDKVersionRequirement: true,\n  });\n  const slug = await Project.getSlugAsync(projectDir);\n\n  const api = ApiV2.clientForUser(user);\n  const result = await api.postAsync('publish/details', {\n    owner: exp.owner,\n    publishId: options.publishId,\n    slug,\n  });\n\n  if (!result.queryResult) {\n    throw new Error('No records found matching your query.');\n  }\n\n  return result.queryResult;\n}\n\nexport async function printPublicationDetailAsync(\n  detail: PublicationDetail,\n  options: DetailOptions\n) {\n  if (options.raw) {\n    console.log(JSON.stringify(detail));\n    return;\n  }\n\n  let manifest = detail.manifest;\n  delete detail.manifest;\n\n  // Print general release info\n  let generalTableString = table.printTableJson(detail, 'Release Description');\n  console.log(generalTableString);\n\n  // Print manifest info\n  let manifestTableString = table.printTableJson(manifest, 'Manifest Details');\n  console.log(manifestTableString);\n}\n"],"file":"PublishUtils.js"}